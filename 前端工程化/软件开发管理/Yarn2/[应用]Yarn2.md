# Yarn 2

在以前，项目管理器通常全局安装，负责整个系统范围的包管理。因为项目管理器自身的版本问题，由不同版本的项目管理器管理的项目往往不能通用，然而项目管理器是全局安装的，这点比较麻烦，比如：BI依赖yarn@1.18。为了解决这种问题，yarn2做出了改进，不同于yarn1，yarn2视自身为项目依赖，所以将安装在项目中，并且需要你将其提交到存储库。yarn2也不再负责系统范围的包管理，`yarn global`也被移除。

yarn2的优点：https://yarnpkg.com/getting-started/qa#why-should-you-upgrade-to-yarn-modern


### **升级yarn 2 注意事项**

- 环境：node 10.19+

- 配置文件名称修改，目前为`.yarnrc.yml`

  yarn 1使用`.yarnrc`作为配置文件名，yarn 2使用`.yarnrc.yml`，这样可以让第三方工具或者用户很容易辨别当前项目使用的yarn 版本。另外，相对yarn 1配置，yarn 2拥有了更多的配置项。

  yarn 2只会读取项目中`.yarnrc.yml`文件，`.yarnrc`与`.npmrc`文件将不会被yarn 2使用。

  以`YARN_`开头的环境变量会覆盖yarn 2的配置中对应的配置，比如：设置`YARN_NPM_REGISTRY_SERVER`环境变量将会改变`npmRegistryServer`的值。

- 使用`yarn dlx`替代`yarn global`

- Fix dependencies with packageExtensions

- 使用`yarn run`调用bin文件，而不是`node_modules/.bin`

  当启用Plug'n'Play后，node_modules不存在了，所以`node_modules/.bin`将失效。
  
  **可以使用`yarn bin`查看当前目录存在多少个bin可执行文件。**

  ```bash
    # error
    node_modules/.bin/jest

    # good
    yarn run jest
    # or
    yarn jest
  ```
- 通过`yarn node bin.js`而不是`node bin.js`来运行JavaScript脚本

  > We now need to inject some variables into the environment for Node to be able to locate your dependencies. In order to make this possible, we ask you to use yarn node which transparently does the heavy lifting.
  >
  >Note: this section only applies to the shell CLI. The commands defined in your scripts are unaffected, as we make sure that node always points to the right location, with the right variables already set.

- 手动调用`pre`与`post`脚本

  ```json
    {
      "scripts": {
        "prestart": "do-something",
        "start": "yarn prestart && http-server"
      }
    }
  ```
  对于用户自定义的`pre`与`post`脚本，需要用户手动调用。但是yarn还是会在执行`yarn install`时自动调用`preinstall`及`postinstall`。

- Setup your IDE for PnP support

- _当你有某些特殊的工具与yarn 2搭配使用时，可以查看yarn 2的[端对端测试](https://github.com/yarnpkg/berry#current-status)以学习一些针对这种工具的独特配置_

- 不要使用`bundleDependencies`

  可以看[bundleDependencies介绍](./[介绍]npm-pack与bundleDependencies.md)。这时一种过时的解决方案，有着一系列的问题：

   - 它依赖于node_modules 结构，没法很好的支持 Plug'n'Play
  
   - 它会干扰 nohoist

  >    - It encodes the hoisting inside the package, which is the exact opposite of what we aim for
  >    - It messes with the hoisting of other packages
  >    - Etc, etc, etc

  > So how to replace them? There are different ways:
  > 
  > If you need to patch a package, just fork it or reference it through file: (it's perfectly fine even for transitive dependencies to use this protocol). The portal: and patch: protocols are also options, although they'll only work for Yarn consumers.
  > 
  > If you need to ship a package to your customers as a standalone (no dependencies), bundle it yourself using Webpack, Rollup, or similar tools.


- 必要的时候：启用`node_modules` plugin

  yarn 2默认使用`PnP`，但是有些第三方库没发很好的支持，这个时候只能启用yarn 2内置`node_modules`插件，这时模块安装就像yarn 1一样会放在node_modules文件夹中。

  > PnP兼容表格：[https://yarnpkg.com/features/pnp#compatibility-table](https://yarnpkg.com/features/pnp#compatibility-table)

  在`.yarnrc.yml`文件中加入如下配置：

  ```yaml
    # 可选："pnp" | "node-modules"  默认： "pnp"
    nodeLinker: "node-modules"
  ```
  
  启用这个插件只会让`PnP`失效，`zero install`还是会工作，下次安装，node_modules中的包将直接从`.yarn/cache`文件夹中读取。

   
- 使用`nmHoistingLimits`配置替换`nohoist`配置

  `nohoist`是 yarn 1给不支持workspaces的第三方工具提供的降级方案。但是它的之前工作方式导致其bug较多，配置起来比较混乱，yarn 2简化了其配置，只提供三种固定模式配置。

  ```yaml
    # 可选："none" | "workspaces" | "dependencies"  默认："none"
    nmHoistingLimits: "none"
  ```



### **哪些文件需要配置在`.gitignore`**

如果使用 Zero-Install:

```bash
# 除了 cache releases plugins sdks versions 文件夹
# 其他全部忽略

# .gitignore
.yarn/*
!.yarn/cache
!.yarn/releases
!.yarn/plugins
!.yarn/sdks
!.yarn/versions
```

如果不使用：

```bash
# 新增 忽略 cache 文件夹 .pnp.*
.yarn/*
!.yarn/releases
!.yarn/plugins
!.yarn/sdks
!.yarn/versions
.pnp.*
```

- `.yarn/unplugged` 与  `.yarn/build-state.yml`应该被忽略，因为它们保存的是针对特定机器的构建信息（非通用）。但是，忽略它们可能会影响Zero-Install（如果有影响，将`enabledScripts`设为`false`）。

- `.yarn/cache` 与 `.pnp.*` 可以被安全的忽略，在执行`yarn install`时，yarn2 可以根据`yarn.lock`文件重新生成。但是，忽略了它们也就相当于放弃了 Zero-Install 功能。另外也会影响PnP

- `.yarn/plugins` 与 `.yarn/releases` 包含了当前仓库依赖的对应版本的 yarn 代码及其插件代码（由`yarn set version`指定）。yarn 2把其视作仓库的本地依赖，所以自然需要将代码存放在仓库中。如果将其忽略，将不能保证当前仓库的yarn 版本正确，将会引发潜在的问题。

- `.yarn/sdks` contains the editor SDKs generated by PnPify. Whether to keep it in your repository or not is up to you; if you don't, you'll need to follow the editor procedure again on new clones. 

- `.yarn/versions` is used by the version plugin to store the package release definitions. You will want to keep it within your repository.

- `.yarn/install-state.gz` 不用被提交，它是一个用于优化yarn 工作的文件，保存着当前workspaces的状态信息，有了它，yarn 在下一次执行指令的时候就不需要重新对整个workspaces进行解析

- `yarn.lock` 是整个项目的基础，一定要提交。

- `.yarnrc.yml`是配置数据，要提交


